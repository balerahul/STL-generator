"""Setup configuration for STL Grid Generator."""

import os
import sys
import shutil
import stat
from setuptools import setup, find_packages
from setuptools.command.develop import develop
from setuptools.command.install import install
from pathlib import Path

# Read README for long description
this_directory = Path(__file__).parent
long_description = ""
readme_path = this_directory / "README.md"
if readme_path.exists():
    long_description = readme_path.read_text(encoding='utf-8')

# Read version from package
version = "0.1.0"


def create_local_binary():
    """Create a local binary in the bin/ directory."""
    bin_dir = Path(__file__).parent / "bin"
    bin_dir.mkdir(exist_ok=True)

    binary_name = "stl-grid-gen"
    if os.name == 'nt':  # Windows
        binary_name += ".exe"

    binary_path = bin_dir / binary_name

    # Create a wrapper script using the current Python interpreter
    script_content = f"""#!{sys.executable}
import sys
from stl_grid_generator.cli import main

if __name__ == "__main__":
    main()
"""

    with open(binary_path, 'w') as f:
        f.write(script_content)

    # Make it executable
    st = os.stat(binary_path)
    os.chmod(binary_path, st.st_mode | stat.S_IEXEC)

    return binary_path


def print_installation_info():
    """Print information about the installed command-line tool."""
    print("\n" + "="*60)
    print("ðŸŽ‰ STL Grid Generator installed successfully!")
    print("="*60)

    # Create local binary
    local_binary = create_local_binary()
    print(f"ðŸ“ Local binary created at: {local_binary}")

    # Try to find the system binary location
    binary_path = shutil.which('stl-grid-gen')
    if binary_path:
        print(f"ðŸ“ System binary installed at: {binary_path}")
    else:
        # Fallback to common locations
        if hasattr(sys, 'real_prefix') or (hasattr(sys, 'base_prefix') and sys.base_prefix != sys.prefix):
            # We're in a virtual environment
            venv_bin = os.path.join(sys.prefix, 'bin', 'stl-grid-gen')
            if os.name == 'nt':  # Windows
                venv_bin = os.path.join(sys.prefix, 'Scripts', 'stl-grid-gen.exe')
            print(f"ðŸ“ System binary installed at: {venv_bin}")
        else:
            print("ðŸ“ System binary installed in PATH")

    print("\nðŸš€ Quick start:")
    print("   stl-grid-gen --help")
    print("   ./bin/stl-grid-gen --help  (local binary)")
    print("   stl-grid-gen --generate-config my_config.yaml")
    print("   stl-grid-gen --config my_config.yaml")

    print("\nðŸ“š Documentation and examples:")
    print("   README.md - Full documentation")
    print("   examples/ - Sample configuration files")

    print("\nâœ¨ Features:")
    print("   â€¢ YAML configuration files (recommended)")
    print("   â€¢ Multiple orientations (X, Y, Z planes)")
    print("   â€¢ Relative and absolute inner hole sizing")
    print("   â€¢ ASCII and binary STL output")
    print("   â€¢ Command-line argument overrides")

    print("="*60 + "\n")


class PostDevelopCommand(develop):
    """Post-installation for development mode."""
    def run(self):
        develop.run(self)
        print_installation_info()


class PostInstallCommand(install):
    """Post-installation for install mode."""
    def run(self):
        install.run(self)
        print_installation_info()

setup(
    name="stl-grid-generator",
    version=version,
    author="Generated by Claude Code",
    author_email="noreply@example.com",
    description="Generate rectangular STL grids with optional holes",
    long_description=long_description,
    long_description_content_type="text/markdown",
    url="https://github.com/example/stl-grid-generator",
    packages=find_packages(),
    classifiers=[
        "Development Status :: 4 - Beta",
        "Intended Audience :: Developers",
        "Intended Audience :: Manufacturing",
        "Topic :: Scientific/Engineering :: Visualization",
        "Topic :: Multimedia :: Graphics :: 3D Modeling",
        "License :: OSI Approved :: MIT License",
        "Programming Language :: Python :: 3",
        "Programming Language :: Python :: 3.7",
        "Programming Language :: Python :: 3.8",
        "Programming Language :: Python :: 3.9",
        "Programming Language :: Python :: 3.10",
        "Programming Language :: Python :: 3.11",
        "Operating System :: OS Independent",
    ],
    python_requires=">=3.7",
    install_requires=[
        "numpy>=1.18.0",
        "PyYAML>=5.4.0",
    ],
    extras_require={
        "earcut": ["mapbox_earcut>=1.0.0"],
        "trimesh": ["trimesh>=3.0.0", "shapely>=1.7.0"],
        "full": ["mapbox_earcut>=1.0.0", "trimesh>=3.0.0", "shapely>=1.7.0"],
        "dev": [
            "pytest>=6.0",
            "pytest-cov>=2.10",
            "black>=21.0",
            "flake8>=3.8",
            "mypy>=0.800",
        ],
    },
    entry_points={
        "console_scripts": [
            "stl-grid-gen=stl_grid_generator.cli:main",
        ],
    },
    cmdclass={
        'develop': PostDevelopCommand,
        'install': PostInstallCommand,
    },
    keywords="stl mesh 3d grid generator cad manufacturing",
    project_urls={
        "Bug Reports": "https://github.com/example/stl-grid-generator/issues",
        "Source": "https://github.com/example/stl-grid-generator",
        "Documentation": "https://github.com/example/stl-grid-generator#readme",
    },
)